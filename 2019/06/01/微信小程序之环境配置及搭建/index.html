<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    微信小程序之环境配置及搭建 |  Brace
  </title>
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/css/style.css">

  
<script src="/js/pace.min.js"></script>


  

  

<meta name="generator" content="Hexo 4.2.0"></head>

</html>

<body>
  <div id="app">
    <main class="content">
      <section class="outer">
  <article id="post-微信小程序之环境配置及搭建" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  微信小程序之环境配置及搭建
</h1>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/06/01/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%B9%8B%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%90%AD%E5%BB%BA/" class="article-date">
  <time datetime="2019-06-01T08:18:29.000Z" itemprop="datePublished">2019-06-01</time>
</a>
      
    </div>
    

    
    
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h4 id="准备域名和证书"><a href="#准备域名和证书" class="headerlink" title="准备域名和证书"></a>准备域名和证书</h4><h5 id="域名注册"><a href="#域名注册" class="headerlink" title="域名注册"></a>域名注册</h5><p>如果您还没有域名，可以在腾讯云上选购。</p>
<h5 id="域名解析"><a href="#域名解析" class="headerlink" title="域名解析"></a>域名解析</h5><p>域名购买完成后,需要将域名解析到实验云主机上。域名设置解析后需要过一段时间才会生效，通过 ping 命令检查域名是否生效。</p>
<h5 id="申请SSL证书"><a href="#申请SSL证书" class="headerlink" title="申请SSL证书"></a>申请SSL证书</h5><p>腾讯云提供了 SSL，证书的免费申请。申请提交后，审批结果会以短信的形式通知。审批通过后，可以到 SSL 控制台下载您的证书文件。</p>
<h4 id="搭建小程序开发环境"><a href="#搭建小程序开发环境" class="headerlink" title="搭建小程序开发环境"></a>搭建小程序开发环境</h4><h5 id="注册开发者账号"><a href="#注册开发者账号" class="headerlink" title="注册开发者账号"></a>注册开发者账号</h5><p>如果你还不是小程序开发者，请先在微信公众平台并注册：<br><a href="https://mp.weixin.qq.com" target="_blank" rel="noopener">https://mp.weixin.qq.com</a></p>
<h5 id="配置小程序服务器信息"><a href="#配置小程序服务器信息" class="headerlink" title="配置小程序服务器信息"></a>配置小程序服务器信息</h5><p>登录微信公众平台后，依次进入 设置 - 开发设置 - 服务器域名 - 修改。<br>扫码完成身份校验后，request 合法域名和 socket 合法域名均填写在上一步准备好的域名地址。<br>配置完成后，点击 保存并提交。</p>
<h5 id="运行配套小程序代码"><a href="#运行配套小程序代码" class="headerlink" title="运行配套小程序代码"></a>运行配套小程序代码</h5><p>要运行本实验配套的小程序代码，文末下载相关的源码和开发者工具。</p>
<h5 id="设置实验域名"><a href="#设置实验域名" class="headerlink" title="设置实验域名"></a>设置实验域名</h5><p>在开发工具的编辑面板中，选中app.js进行编辑，需要修改小程序通信域名，请参考下面的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    config: &#123;</span><br><span class="line">        host: &#39;&#39; &#x2F;&#x2F; 这个地方填写你的域名</span><br><span class="line">    &#125;,</span><br><span class="line">    onLaunch () &#123;</span><br><span class="line">        console.log(&#39;App.onLaunch()&#39;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="搭建HTTP服务"><a href="#搭建HTTP服务" class="headerlink" title="搭建HTTP服务"></a>搭建HTTP服务</h4><h5 id="安装NodeJs和NPM"><a href="#安装NodeJs和NPM" class="headerlink" title="安装NodeJs和NPM"></a>安装NodeJs和NPM</h5><p>使用下面的命令安装 NodeJS 和 NPM</p>
<figure class="highlight plain"><figcaption><span>--silent --location</span><a href="https://rpm.nodesource.com/setup_8.x" target="_blank" rel="noopener">| sudo bash -</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nodejs -y</span><br></pre></td></tr></table></figure>
<p>安装完成后，使用下面的命令测试安装结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure>
<h5 id="编写HTTPServer源码"><a href="#编写HTTPServer源码" class="headerlink" title="编写HTTPServer源码"></a>编写HTTPServer源码</h5><p>创建工作目录<br>使用下面的命令在服务器创建一个工作目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;release&#x2F;weapp</span><br></pre></td></tr></table></figure>
<p>进入此工作目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;release&#x2F;weapp</span><br></pre></td></tr></table></figure>
<p>创建 package.json在刚才创建的工作目录创建package.json，添加我们服务器包的名称和版本号，可参考下面的示例。进入此工作目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;weapp&quot;,</span><br><span class="line">    &quot;version&quot;: &quot;1.0.0&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成后，使用 Ctrl + S 保存文件添加 Server 源码在工作目录创建 app.js，使用 Express.js 来监听 8765 端口，可参考下面的示例代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 引用 express 来支持 HTTP Server 的实现</span><br><span class="line">const express &#x3D; require(&#39;express&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建一个 express 实例</span><br><span class="line">const app &#x3D; express();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 实现唯一的一个中间件，对于所有请求，都输出 &quot;Response from express&quot;</span><br><span class="line">app.use((request, response, next) &#x3D;&gt; &#123;</span><br><span class="line">    response.write(&#39;Response from express&#39;);</span><br><span class="line">    response.end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 监听端口，等待连接</span><br><span class="line">const port &#x3D; 8765;</span><br><span class="line">app.listen(port);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 输出服务器启动日志</span><br><span class="line">console.log(&#96;Server listening at http:&#x2F;&#x2F;127.0.0.1:$&#123;port&#125;&#96;);</span><br></pre></td></tr></table></figure>

<h5 id="运行HTTP服务"><a href="#运行HTTP服务" class="headerlink" title="运行HTTP服务"></a>运行HTTP服务</h5><p>安装 PM2  在开始之前，我们先来安装 PM2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install pm2 --global</span><br></pre></td></tr></table></figure>
<p>PM2 安装时间可能稍长，请耐心等候。 </p>
<p>安装 Express</p>
<p>我们的服务器源码里使用到了 Express 模块，下面的命令使用 NPM 来安装 Express</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;release&#x2F;weapp</span><br><span class="line">npm install express --save</span><br></pre></td></tr></table></figure>
<p>启动服务  安装完成后，使用 PM2 来启动 HTTP 服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;release&#x2F;weapp</span><br><span class="line">pm2 start app.js</span><br></pre></td></tr></table></figure>
<p>现在，您的HTTP服务已经在云服务器上运行要查看服务输出的日志，可以使用下面的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs</span><br></pre></td></tr></table></figure>
<h4 id="搭建HTTPS服务"><a href="#搭建HTTPS服务" class="headerlink" title="搭建HTTPS服务"></a>搭建HTTPS服务</h4><h5 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h5><p>在 CentOS 上，可直接使用 yum 来安装 Nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx -y</span><br></pre></td></tr></table></figure>
<p>安装完成后，使用 nginx 命令启动 Nginx：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx</span><br></pre></td></tr></table></figure>
<p>此时，访问 服务器可以看到 Nginx 的测试页面 </p>
<h5 id="配置HTTPS反向代理"><a href="#配置HTTPS反向代理" class="headerlink" title="配置HTTPS反向代理"></a>配置HTTPS反向代理</h5><p>外网用户访问服务器的 Web 服务由 Nginx 提供，Nginx 需要配置反向代理才能使得 Web 服务转发到本地的 Node 服务。<br>先将之前下载的 SSL 证书(解压后 Nginx 目录分别以 crt 和 key 作为后缀的文件)通过拖动到左侧文件浏览器/etc/nginx目录的方式来上传文件到服务器上<br>如何上传 SSL 证书到 /etc/nginx 目录<br>Nginx 配置目录在 /etc/nginx/conf.d，我们在该目录创建 ssl.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 443;</span><br><span class="line">        server_name www.example.com; # 改为绑定证书的域名</span><br><span class="line">        # ssl 配置</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate 1_www.example.com_bundle.crt; # 改为自己申请得到的 crt 文件的名称</span><br><span class="line">        ssl_certificate_key 2_www.example.com.key; # 改为自己申请得到的 key 文件的名称</span><br><span class="line">        ssl_session_timeout 5m;</span><br><span class="line">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;127.0.0.1:8765;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>按 Ctrl + S 保存配置文件，让 Nginx 重新加载配置使其生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
<p>在浏览器通过 https 的方式访问你解析的域名来测试 HTTPS 是否成功启动</p>
<h5 id="在小程序中测试HTTPS访问"><a href="#在小程序中测试HTTPS访问" class="headerlink" title="在小程序中测试HTTPS访问"></a>在小程序中测试HTTPS访问</h5><p>打开配套的小程序，点击 实验一：HTTPS，点击 发送请求 来测试访问结果。<br>如果服务器响应成功，请点击下一步。</p>
<h4 id="小程序会话"><a href="#小程序会话" class="headerlink" title="小程序会话"></a>小程序会话</h4><h5 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h5><p>使用 Yum 在机器上安装 MongoDB及其客户端命令行工具：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install mongodb-server mongodb -y</span><br></pre></td></tr></table></figure>

<p>安装结束后，可以使用下面的命令查看安装的版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongod --version</span><br><span class="line">mongo --version</span><br></pre></td></tr></table></figure>
<h5 id="启动MongoDB"><a href="#启动MongoDB" class="headerlink" title="启动MongoDB"></a>启动MongoDB</h5><p>创建目录，用于 MongoDB 数据和日志存储：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;mongodb</span><br><span class="line">mkdir -p &#x2F;data&#x2F;logs&#x2F;mongodb</span><br></pre></td></tr></table></figure>

<p>创建后，使用下面的命令来启动 MongoDB：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --fork --dbpath &#x2F;data&#x2F;mongodb --logpath &#x2F;data&#x2F;logs&#x2F;mongodb&#x2F;weapp.log</span><br></pre></td></tr></table></figure>
<h5 id="添加MongoDB用户"><a href="#添加MongoDB用户" class="headerlink" title="添加MongoDB用户"></a>添加MongoDB用户</h5><p>登录本地 MongoDB 服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo</span><br></pre></td></tr></table></figure>
<p>登录后，创建一个用户 weapp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use weapp;</span><br><span class="line">db.createUser(&#123; user: &#39;weapp&#39;, pwd: &#39;weapp-dev&#39;, roles: [&#39;dbAdmin&#39;, &#39;readWrite&#39;]&#125;);</span><br></pre></td></tr></table></figure>
<p>创建完成后，使用 exit 退出命令行工具。</p>
<h5 id="安装nodejs模块"><a href="#安装nodejs模块" class="headerlink" title="安装nodejs模块"></a>安装nodejs模块</h5><p>实现小程序的会话功能，我们需要安装 connect-mongo和 wafer-node-session<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> cd &#x2F;data&#x2F;release&#x2F;weapp</span><br><span class="line">npm install connect-mongo wafer-node-session --save</span><br></pre></td></tr></table></figure></p>
<h5 id="实现小程序会话"><a href="#实现小程序会话" class="headerlink" title="实现小程序会话"></a>实现小程序会话</h5><p>在工作目录创建配置文件 config.js，用于保存我们服务所用的配置，可参考下面的实现(注：请将参考配置文件中的YORUAPPID和YOURAPPSECRET替换为你申请的小程序对应的 AppID 和 AppSecret)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123; </span><br><span class="line">    serverPort: &#39;8765&#39;, </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 小程序 appId 和 appSecret </span><br><span class="line">    &#x2F;&#x2F; 请到 https:&#x2F;&#x2F;mp.weixin.qq.com 获取 AppID 和 AppSecret</span><br><span class="line">    appId: &#39;YORU_APP_ID&#39;, </span><br><span class="line">    appSecret: &#39;YOUR_APP_SECRET&#39;, </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; mongodb 连接配置，生产环境请使用更复杂的用户名密码</span><br><span class="line">    mongoHost: &#39;127.0.0.1&#39;, </span><br><span class="line">    mongoPort: &#39;27017&#39;, </span><br><span class="line">    mongoUser: &#39;weapp&#39;, </span><br><span class="line">    mongoPass: &#39;weapp-dev&#39;, </span><br><span class="line">    mongoDb: &#39;weapp&#39;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>编辑 app.js，添加会话实现逻辑，可参考下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 引用 express 来支持 HTTP Server 的实现</span><br><span class="line">const express &#x3D; require(&#39;express&#39;);</span><br><span class="line">&#x2F;&#x2F; 引用 wafer-session 支持小程序会话</span><br><span class="line">const waferSession &#x3D; require(&#39;wafer-node-session&#39;); </span><br><span class="line">&#x2F;&#x2F; 使用 MongoDB 作为会话的存储</span><br><span class="line">const MongoStore &#x3D; require(&#39;connect-mongo&#39;)(waferSession); </span><br><span class="line">&#x2F;&#x2F; 引入配置文件</span><br><span class="line">const config &#x3D; require(&#39;.&#x2F;config&#39;); </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建一个 express 实例</span><br><span class="line">const app &#x3D; express();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 添加会话中间件，登录地址是 &#x2F;login</span><br><span class="line">app.use(waferSession(&#123; </span><br><span class="line">    appId: config.appId, </span><br><span class="line">    appSecret: config.appSecret, </span><br><span class="line">    loginPath: &#39;&#x2F;login&#39;,</span><br><span class="line">    store: new MongoStore(&#123; </span><br><span class="line">        url: &#96;mongodb:&#x2F;&#x2F;$&#123;config.mongoUser&#125;:$&#123;config.mongoPass&#125;@$&#123;config.mongoHost&#125;:$&#123;config.mongoPort&#125;&#x2F;$&#123;config.mongoDb&#125;&#96; </span><br><span class="line">    &#125;) </span><br><span class="line">&#125;)); </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 在路由 &#x2F;me 下，输出会话里包含的用户信息</span><br><span class="line">app.use(&#39;&#x2F;me&#39;, (request, response, next) &#x3D;&gt; &#123; </span><br><span class="line">    response.json(request.session ? request.session.userInfo : &#123; noBody: true &#125;); </span><br><span class="line">    if (request.session) &#123;</span><br><span class="line">        console.log(&#96;Wafer session success with openId&#x3D;$&#123;request.session.userInfo.openId&#125;&#96;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;); </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 实现一个中间件，对于未处理的请求，都输出 &quot;Response from express&quot;</span><br><span class="line">app.use((request, response, next) &#x3D;&gt; &#123;</span><br><span class="line">    response.write(&#39;Response from express&#39;);</span><br><span class="line">    response.end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 监听端口，等待连接</span><br><span class="line">app.listen(config.serverPort);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 输出服务器启动日志</span><br><span class="line">console.log(&#96;Server listening at http:&#x2F;&#x2F;127.0.0.1:$&#123;config.serverPort&#125;&#96;);</span><br></pre></td></tr></table></figure>
<p>源码编写完成后，重启服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 restart app</span><br></pre></td></tr></table></figure>
<p>重启后，使用配套的小程序完成会话测试：打开配套小程序 - 点击 实验二：会话 - 获取会话，如果您能看到您的微信头像，那就表示会话已经成功获取了。</p>
<h4 id="websocket服务"><a href="#websocket服务" class="headerlink" title="websocket服务"></a>websocket服务</h4><h5 id="安装Node模块"><a href="#安装Node模块" class="headerlink" title="安装Node模块"></a>安装Node模块</h5><p>本实验使用 ws 模块来在服务器上支持 WebSocket 协议，下面使用 NPM 来安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;release&#x2F;weapp</span><br><span class="line">npm install ws --save</span><br></pre></td></tr></table></figure>
<h5 id="实现Websocket服务器"><a href="#实现Websocket服务器" class="headerlink" title="实现Websocket服务器"></a>实现Websocket服务器</h5><p>创建 websocket.js，实现 WebSocket 服务，可参考下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 引入 ws 支持 WebSocket 的实现</span><br><span class="line">const ws &#x3D; require(&#39;ws&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 导出处理方法</span><br><span class="line">exports.listen &#x3D; listen;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 在 HTTP Server 上处理 WebSocket 请求</span><br><span class="line"> * @param &#123;http.Server&#125; server</span><br><span class="line"> * @param &#123;wafer.SessionMiddleware&#125; sessionMiddleware</span><br><span class="line"> *&#x2F;</span><br><span class="line">function listen(server, sessionMiddleware) &#123;</span><br><span class="line">    &#x2F;&#x2F; 使用 HTTP Server 创建 WebSocket 服务，使用 path 参数指定需要升级为 WebSocket 的路径</span><br><span class="line">    const wss &#x3D; new ws.Server(&#123; server, path: &#39;&#x2F;ws&#39; &#125;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 监听 WebSocket 连接建立</span><br><span class="line">    wss.on(&#39;connection&#39;, (ws,request) &#x3D;&gt; &#123;&#x2F;&#x2F; 要升级到 WebSocket 协议的 HTTP 连接</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 被升级到 WebSocket 的请求不会被 express 处理，</span><br><span class="line">        &#x2F;&#x2F; 需要使用会话中间节获取会话</span><br><span class="line">        sessionMiddleware(request, null, () &#x3D;&gt; &#123;</span><br><span class="line">            const session &#x3D; request.session;</span><br><span class="line">            if (!session) &#123;</span><br><span class="line">                &#x2F;&#x2F; 没有获取到会话，强制断开 WebSocket 连接</span><br><span class="line">                ws.send(JSON.stringify(request.sessionError) || &quot;No session avaliable&quot;);</span><br><span class="line">                ws.close();</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; 保留这个日志的输出可让实验室能检查到当前步骤是否完成</span><br><span class="line">            console.log(&#96;WebSocket client connected with openId&#x3D;$&#123;session.userInfo.openId&#125;&#96;);</span><br><span class="line">            serveMessage(ws, session.userInfo);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 监听 WebSocket 服务的错误</span><br><span class="line">    wss.on(&#39;error&#39;, (err) &#x3D;&gt; &#123;</span><br><span class="line">        console.log(err);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 进行简单的 WebSocket 服务，对于客户端发来的所有消息都回复回去</span><br><span class="line"> *&#x2F;</span><br><span class="line">function serveMessage(ws, userInfo) &#123;</span><br><span class="line">    &#x2F;&#x2F; 监听客户端发来的消息</span><br><span class="line">    ws.on(&#39;message&#39;, (message) &#x3D;&gt; &#123;</span><br><span class="line">        console.log(&#96;WebSocket received: $&#123;message&#125;&#96;);</span><br><span class="line">        ws.send(&#96;Server: Received($&#123;message&#125;)&#96;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 监听关闭事件</span><br><span class="line">    ws.on(&#39;close&#39;, (code, message) &#x3D;&gt; &#123;</span><br><span class="line">        console.log(&#96;WebSocket client closed (code: $&#123;code&#125;, message: $&#123;message || &#39;none&#39;&#125;)&#96;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 连接后马上发送 hello 消息给会话对应的用户</span><br><span class="line">    ws.send(&#96;Server: 恭喜，$&#123;userInfo.nickName&#125;&#96;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编辑 app.js，调用 WebSocket 服务，可参考下面代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; HTTP 模块同时支持 Express 和 WebSocket</span><br><span class="line">const http &#x3D; require(&#39;http&#39;); </span><br><span class="line">&#x2F;&#x2F; 引用 express 来支持 HTTP Server 的实现</span><br><span class="line">const express &#x3D; require(&#39;express&#39;);</span><br><span class="line">&#x2F;&#x2F; 引用 wafer-session 支持小程序会话</span><br><span class="line">const waferSession &#x3D; require(&#39;wafer-node-session&#39;); </span><br><span class="line">&#x2F;&#x2F; 使用 MongoDB 作为会话的存储</span><br><span class="line">const MongoStore &#x3D; require(&#39;connect-mongo&#39;)(waferSession); </span><br><span class="line">&#x2F;&#x2F; 引入配置文件</span><br><span class="line">const config &#x3D; require(&#39;.&#x2F;config&#39;); </span><br><span class="line">&#x2F;&#x2F; 引入 WebSocket 服务实现</span><br><span class="line">const websocket &#x3D; require(&#39;.&#x2F;websocket&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建一个 express 实例</span><br><span class="line">const app &#x3D; express();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 独立出会话中间件给 express 和 ws 使用</span><br><span class="line">const sessionMiddleware &#x3D; waferSession(&#123;</span><br><span class="line">    appId: config.appId,</span><br><span class="line">    appSecret: config.appSecret,</span><br><span class="line">    loginPath: &#39;&#x2F;login&#39;,</span><br><span class="line">    store: new MongoStore(&#123;</span><br><span class="line">        url: &#96;mongodb:&#x2F;&#x2F;$&#123;config.mongoUser&#125;:$&#123;config.mongoPass&#125;@$&#123;config.mongoHost&#125;:$&#123;config.mongoPort&#125;&#x2F;$&#123;config.mongoDb&#125;&#96;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line">app.use(sessionMiddleware);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 在路由 &#x2F;me 下，输出会话里包含的用户信息</span><br><span class="line">app.use(&#39;&#x2F;me&#39;, (request, response, next) &#x3D;&gt; &#123; </span><br><span class="line">    response.json(request.session ? request.session.userInfo : &#123; noBody: true &#125;); </span><br><span class="line">    if (request.session) &#123;</span><br><span class="line">        console.log(&#96;Wafer session success with openId&#x3D;$&#123;request.session.userInfo.openId&#125;&#96;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;); </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 实现一个中间件，对于未处理的请求，都输出 &quot;Response from express&quot;</span><br><span class="line">app.use((request, response, next) &#x3D;&gt; &#123;</span><br><span class="line">    response.write(&#39;Response from express&#39;);</span><br><span class="line">    response.end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建 HTTP Server 而不是直接使用 express 监听</span><br><span class="line">const server &#x3D; http.createServer(app);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 让 WebSocket 服务在创建的 HTTP 服务器上监听</span><br><span class="line">websocket.listen(server, sessionMiddleware);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 启动 HTTP 服务</span><br><span class="line">server.listen(config.serverPort);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 输出服务器启动日志</span><br><span class="line">console.log(&#96;Server listening at http:&#x2F;&#x2F;127.0.0.1:$&#123;config.serverPort&#125;&#96;);</span><br></pre></td></tr></table></figure>
<p>修改完成后，按 Ctrl + S 保存文件，并重启服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 restart app</span><br></pre></td></tr></table></figure>
<h5 id="更新Nginx代理"><a href="#更新Nginx代理" class="headerlink" title="更新Nginx代理"></a>更新Nginx代理</h5><p>编辑 Nginx 配置 ssl.conf，添加 WebSocket 支持，可参考下面的配置(注：请将参考配置文件中的 <a href="http://www.example.com" target="_blank" rel="noopener">www.example.com</a> 替换为前面步骤申请的域名，将 1_<a href="http://www.example.com.crt" target="_blank" rel="noopener">www.example.com.crt</a> 和 2_<a href="http://www.example.com.key" target="_blank" rel="noopener">www.example.com.key</a> 替换为前面步骤申请并上传的 SSL 证书的名称)：</p>
<figure class="highlight plain"><figcaption><span>WebSocket 配置</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">    default upgrade;</span><br><span class="line">    &#39;&#39;      close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 443;</span><br><span class="line">        server_name www.example.com; # 改为绑定证书的域名</span><br><span class="line">        # ssl 配置</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate 1_www.example.com.crt; # 改为自己申请得到的 crt 文件的名称</span><br><span class="line">        ssl_certificate_key 2_www.example.com.key; # 改为自己申请得到的 key 文件的名称</span><br><span class="line">        ssl_session_timeout 5m;</span><br><span class="line">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">        # WebSocket 配置</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection $connection_upgrade;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;127.0.0.1:8765;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>配置完成后，按 Ctrl + S 保存，并且通知 Nginx 进程重新加载配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<h5 id="测试Websocket"><a href="#测试Websocket" class="headerlink" title="测试Websocket"></a>测试Websocket</h5><p>打开配套的小程序，点击 实验三：WebSocket。进入测试页面后，点击 连接 按钮，如果出现连接成功的提示，表示 WebSocket 服务已经正常运行，可以收发消息。</p>
<h4 id="剪刀石头布小游戏"><a href="#剪刀石头布小游戏" class="headerlink" title="剪刀石头布小游戏"></a>剪刀石头布小游戏</h4><h5 id="实现游戏房间的逻辑"><a href="#实现游戏房间的逻辑" class="headerlink" title="实现游戏房间的逻辑"></a>实现游戏房间的逻辑</h5><p>创建 /data/release/weapp/game 目录用于存放剪刀石头布小游戏的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;release&#x2F;weapp&#x2F;game</span><br></pre></td></tr></table></figure>
<p>添加 game/Room.js 实现游戏房间逻辑，可参考下面的代码：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">enum GameChoice &#123;</span><br><span class="line">    &#x2F;&#x2F; 剪刀</span><br><span class="line">    Scissors &#x3D; 1,</span><br><span class="line">    &#x2F;&#x2F; 石头</span><br><span class="line">    Rock &#x3D; 2,</span><br><span class="line">    &#x2F;&#x2F; 布</span><br><span class="line">    Paper &#x3D; 3</span><br><span class="line">&#125;</span><br><span class="line">*&#x2F;</span><br><span class="line">function judge(choice1, choice2) &#123;</span><br><span class="line">    &#x2F;&#x2F; 和局</span><br><span class="line">    if (choice1 &#x3D;&#x3D; choice2) return 0;</span><br><span class="line">    &#x2F;&#x2F; Player 1 没出，Player 2 胜出</span><br><span class="line">    if (!choice1) return 1;</span><br><span class="line">    &#x2F;&#x2F; Player 2 没出，Player 1 胜出</span><br><span class="line">    if (!choice2) return -1;</span><br><span class="line">    &#x2F;&#x2F; 都出了就这么算</span><br><span class="line">    return (choice1 - choice2 + 3) % 3 &#x3D;&#x3D; 1 ? -1 : 1;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;** @type &#123;Room[]&#125; *&#x2F;</span><br><span class="line">const globalRoomList &#x3D; [];</span><br><span class="line">&#x2F;&#x2F; 每个房间最多两人</span><br><span class="line">const MAX_ROOT_MEMBER &#x3D; 2;</span><br><span class="line">&#x2F;&#x2F; 游戏时间，单位秒</span><br><span class="line">const GAME_TIME &#x3D; 3;</span><br><span class="line">let nextRoomId &#x3D; 0;</span><br><span class="line">&#x2F;** 表示一个房间 *&#x2F;</span><br><span class="line">module.exports &#x3D; class Room &#123;</span><br><span class="line">    &#x2F;** 获取所有房间 *&#x2F;</span><br><span class="line">    static all() &#123;</span><br><span class="line">        return globalRoomList.slice();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;** 获取有座位的房间 *&#x2F;</span><br><span class="line">    static findRoomWithSeat() &#123;</span><br><span class="line">        return globalRoomList.find(x &#x3D;&gt; !x.isFull());</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;** 创建新房间 *&#x2F;</span><br><span class="line">    static create() &#123;</span><br><span class="line">        const room &#x3D; new Room();</span><br><span class="line">        globalRoomList.unshift(room);</span><br><span class="line">        return room;</span><br><span class="line">    &#125;</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        this.id &#x3D; &#96;room$&#123;nextRoomId++&#125;&#96;;</span><br><span class="line">        this.players &#x3D; [];</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;** 添加玩家 *&#x2F;</span><br><span class="line">    addPlayer(player) &#123;</span><br><span class="line">        const &#123; uid, uname &#125; &#x3D; player.user;</span><br><span class="line">        console.log(&#96;Player $&#123;uid&#125;($&#123;uname&#125;) enter $&#123;this.id&#125;&#96;);</span><br><span class="line">        this.players.push(player);</span><br><span class="line">        if (this.isFull()) &#123;</span><br><span class="line">            this.startGame();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;** 删除玩家 *&#x2F;</span><br><span class="line">    removePlayer(player) &#123;</span><br><span class="line">        const &#123; uid, uname &#125; &#x3D; player.user;</span><br><span class="line">        console.log(&#96;Player $&#123;uid&#125;($&#123;uname&#125;) leave $&#123;this.id&#125;&#96;);</span><br><span class="line">        const playerIndex &#x3D; this.players.indexOf(player);</span><br><span class="line">        if (playerIndex !&#x3D; -1) &#123;</span><br><span class="line">            this.players.splice(playerIndex, 1);</span><br><span class="line">        &#125;</span><br><span class="line">        if (this.players.length &#x3D;&#x3D;&#x3D; 0) &#123;</span><br><span class="line">            console.log(&#96;Room $&#123;this.id&#125; is empty now&#96;);</span><br><span class="line">            const roomIndex &#x3D; globalRoomList.indexOf(this);</span><br><span class="line">            if (roomIndex &gt; -1) &#123;</span><br><span class="line">                globalRoomList.splice(roomIndex, 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;** 玩家已满 *&#x2F;</span><br><span class="line">    isFull() &#123;</span><br><span class="line">        return this.players.length &#x3D;&#x3D; MAX_ROOT_MEMBER;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;** 开始游戏 *&#x2F;</span><br><span class="line">    startGame() &#123;</span><br><span class="line">        &#x2F;&#x2F; 保留这行日志输出可以让实验室检查到实验的完成情况</span><br><span class="line">        console.log(&#39;game started!&#39;);</span><br><span class="line">        &#x2F;&#x2F; 当局积分清零</span><br><span class="line">        this.players.forEach(player &#x3D;&gt; player.gameData.roundScore &#x3D; 0);</span><br><span class="line">        &#x2F;&#x2F; 集合玩家用户和游戏数据</span><br><span class="line">        const players &#x3D; this.players.map(player &#x3D;&gt; Object.assign(&#123;&#125;, player.user, player.gameData));</span><br><span class="line">        &#x2F;&#x2F; 通知所有玩家开始</span><br><span class="line">        for (let player of this.players) &#123;</span><br><span class="line">            player.send(&#39;start&#39;, &#123;</span><br><span class="line">                gameTime: GAME_TIME,</span><br><span class="line">                players</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 计时结束</span><br><span class="line">        setTimeout(() &#x3D;&gt; this.finishGame(), GAME_TIME * 1000);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;** 结束游戏 *&#x2F;</span><br><span class="line">    finishGame() &#123;</span><br><span class="line">        const players &#x3D; this.players;</span><br><span class="line">        &#x2F;&#x2F; 两两对比算分</span><br><span class="line">        for (let i &#x3D; 0; i &lt; MAX_ROOT_MEMBER; i++) &#123;</span><br><span class="line">            let p1 &#x3D; players[i];</span><br><span class="line">            if (!p1) break;</span><br><span class="line">            for (let j &#x3D; i + 1; j &lt; MAX_ROOT_MEMBER; j++) &#123;</span><br><span class="line">                let p2 &#x3D; players[j];</span><br><span class="line">                const result &#x3D; judge(p1.gameData.choice, p2.gameData.choice);</span><br><span class="line">                p1.gameData.roundScore -&#x3D; result;</span><br><span class="line">                p2.gameData.roundScore +&#x3D; result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 计算连胜奖励</span><br><span class="line">        for (let player of players) &#123;</span><br><span class="line">            const gameData &#x3D; player.gameData;</span><br><span class="line">            &#x2F;&#x2F; 胜局积分</span><br><span class="line">            if (gameData.roundScore &gt; 0) &#123;</span><br><span class="line">                gameData.winStreak++;</span><br><span class="line">                gameData.roundScore *&#x3D; gameData.winStreak;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; 败局清零</span><br><span class="line">            else if (gameData.roundScore &lt; 0) &#123;</span><br><span class="line">                gameData.roundScore &#x3D; 0;</span><br><span class="line">                gameData.winStreak &#x3D; 0;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; 累积总分</span><br><span class="line">            gameData.totalScore +&#x3D; gameData.roundScore;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 计算结果</span><br><span class="line">        const result &#x3D; players.map(player &#x3D;&gt; &#123;</span><br><span class="line">            const &#123; uid &#125; &#x3D; player.user;</span><br><span class="line">            const &#123; roundScore, totalScore, winStreak, choice &#125; &#x3D; player.gameData;</span><br><span class="line">            return &#123; uid, roundScore, totalScore, winStreak, choice &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">        &#x2F;&#x2F; 通知所有玩家游戏结果</span><br><span class="line">        for (let player of players) &#123;</span><br><span class="line">            player.send(&#39;result&#39;, &#123; result &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="实现玩家逻辑"><a href="#实现玩家逻辑" class="headerlink" title="实现玩家逻辑"></a>实现玩家逻辑</h5><p>添加 game/Player.js 实现玩家逻辑，可参考下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">const Room &#x3D; require(&quot;.&#x2F;Room&quot;);</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 表示一个玩家，处理玩家的公共游戏逻辑，消息处理部分需要具体的玩家实现（请参考 ComputerPlayer 和 HumanPlayer）</span><br><span class="line"> *&#x2F;</span><br><span class="line">module.exports &#x3D; class Player &#123;</span><br><span class="line">    constructor(user) &#123;</span><br><span class="line">        this.id &#x3D; user.uid;</span><br><span class="line">        this.user &#x3D; user;</span><br><span class="line">        this.room &#x3D; null;</span><br><span class="line">        this.gameData &#x3D; &#123;</span><br><span class="line">            &#x2F;&#x2F; 当前的选择（剪刀&#x2F;石头&#x2F;布）</span><br><span class="line">            choice: null,</span><br><span class="line">            &#x2F;&#x2F; 局积分</span><br><span class="line">            roundScore: 0,</span><br><span class="line">            &#x2F;&#x2F; 总积分</span><br><span class="line">            totalScore: 0,</span><br><span class="line">            &#x2F;&#x2F; 连胜次数</span><br><span class="line">            winStreak: 0</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 上线当前玩家，并且异步返回给玩家分配的房间</span><br><span class="line">     *&#x2F;</span><br><span class="line">    online(room) &#123;</span><br><span class="line">        &#x2F;&#x2F; 处理玩家 &#39;join&#39; 消息</span><br><span class="line">        &#x2F;&#x2F; 为玩家寻找一个可用的房间，并且异步返回</span><br><span class="line">        this.receive(&#39;join&#39;, () &#x3D;&gt; &#123;</span><br><span class="line">            if (this.room) &#123;</span><br><span class="line">                this.room.removePlayer(this);</span><br><span class="line">            &#125;</span><br><span class="line">            room &#x3D; this.room &#x3D; room || Room.findRoomWithSeat() || Room.create();</span><br><span class="line">            room.addPlayer(this);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 处理玩家 &#39;choise&#39; 消息</span><br><span class="line">        &#x2F;&#x2F; 需要记录玩家当前的选择，并且通知到房间里的其它玩家</span><br><span class="line">        this.receive(&#39;choice&#39;, (&#123; choice &#125;) &#x3D;&gt; &#123;</span><br><span class="line">            this.gameData.choice &#x3D; choice;</span><br><span class="line">            this.broadcast(&#39;movement&#39;, &#123;</span><br><span class="line">                uid: this.user.uid,</span><br><span class="line">                movement: &quot;choice&quot;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 处理玩家 &#39;leave&#39; 消息</span><br><span class="line">        &#x2F;&#x2F; 让玩家下线</span><br><span class="line">        this.receive(&#39;leave&#39;, () &#x3D;&gt; this.offline);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 下线当前玩家，从房间离开</span><br><span class="line">     *&#x2F;</span><br><span class="line">    offline() &#123;</span><br><span class="line">        if (this.room) &#123;</span><br><span class="line">            this.room.removePlayer(this);</span><br><span class="line">            this.room &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">        this.user &#x3D; null;</span><br><span class="line">        this.gameData &#x3D; null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 发送指定消息给当前玩家，需要具体子类实现</span><br><span class="line">     * @abstract</span><br><span class="line">     * @param &#123;string&#125; message 消息类型</span><br><span class="line">     * @param &#123;*&#125; data 消息数据</span><br><span class="line">     *&#x2F;</span><br><span class="line">    send(message, data) &#123;</span><br><span class="line">        throw new Error(&#39;Not implement: AbstractPlayer.send()&#39;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 处理玩家发送的消息，需要具体子类实现</span><br><span class="line">     * @abstract</span><br><span class="line">     * @param &#123;string&#125; message 消息类型</span><br><span class="line">     * @param &#123;Function&#125; handler</span><br><span class="line">     *&#x2F;</span><br><span class="line">    receive(message, handler) &#123;</span><br><span class="line">        throw new Error(&#39;Not implement: AbstractPlayer.receive()&#39;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 给玩家所在房间里的其它玩家发送消息</span><br><span class="line">     * @param &#123;string&#125; message 消息类型</span><br><span class="line">     * @param &#123;any&#125; data 消息数据</span><br><span class="line">     *&#x2F;</span><br><span class="line">    broadcast(message, data) &#123;</span><br><span class="line">        if (!this.room) return;</span><br><span class="line">        this.others().forEach(neighbor &#x3D;&gt; neighbor.send(message, data));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获得玩家所在房间里的其他玩家</span><br><span class="line">     *&#x2F;</span><br><span class="line">    others() &#123;</span><br><span class="line">        return this.room.players.filter(player &#x3D;&gt; player !&#x3D; this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="实现电脑玩家"><a href="#实现电脑玩家" class="headerlink" title="实现电脑玩家"></a>实现电脑玩家</h5><p>在实现人类玩家之前，我们先来创建 ComputerPlayer.js 来实现电脑玩家</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">const EventEmitter &#x3D; require(&#39;events&#39;);</span><br><span class="line">const Player &#x3D; require(&#39;.&#x2F;Player&#39;);</span><br><span class="line"></span><br><span class="line">let nextComputerId &#x3D; 0;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 机器人玩家实现，使用 EventEmitter 接收和发送消息</span><br><span class="line"> *&#x2F;</span><br><span class="line">module.exports &#x3D; class ComputerPlayer extends Player &#123;</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        const computerId &#x3D; &#96;robot-$&#123;++nextComputerId&#125;&#96;;</span><br><span class="line">        super(&#123;</span><br><span class="line">            uid: computerId,</span><br><span class="line">            uname: computerId,</span><br><span class="line">            uavatar: &#39;http:&#x2F;&#x2F;www.scoutiegirl.com&#x2F;wp-content&#x2F;uploads&#x2F;2015&#x2F;06&#x2F;Blue-Robot.png&#39;</span><br><span class="line">        &#125;);</span><br><span class="line">        this.emitter &#x3D; new EventEmitter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 模拟玩家行为</span><br><span class="line">     *&#x2F;</span><br><span class="line">    simulate() &#123;</span><br><span class="line">        this.receive(&#39;start&#39;, () &#x3D;&gt; this.play());</span><br><span class="line">        this.receive(&#39;result&#39;, () &#x3D;&gt; this.stop());</span><br><span class="line">        this.send(&#39;join&#39;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 游戏开始后，随机时间后随机选择</span><br><span class="line">     *&#x2F;</span><br><span class="line">    play() &#123;</span><br><span class="line">        this.playing &#x3D; true;</span><br><span class="line">        const randomTime &#x3D; () &#x3D;&gt; Math.floor(100 + Math.random() * 2000);</span><br><span class="line">        const randomChoice &#x3D; () &#x3D;&gt; &#123;</span><br><span class="line">            if (!this.playing) return;</span><br><span class="line">            this.send(&quot;choice&quot;, &#123;</span><br><span class="line">                choice: Math.floor(Math.random() * 10000) % 3 + 1</span><br><span class="line">            &#125;);</span><br><span class="line">            setTimeout(randomChoice, randomTime());</span><br><span class="line">        &#125;</span><br><span class="line">        setTimeout(randomChoice, 10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 游戏结束后，标记起来，阻止继续随机选择</span><br><span class="line">     *&#x2F;</span><br><span class="line">    stop() &#123;</span><br><span class="line">        this.playing &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 发送消息给当前玩家，直接转发到 emitter</span><br><span class="line">     *&#x2F;</span><br><span class="line">    send(message, data) &#123;</span><br><span class="line">        this.emitter.emit(message, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 从当前的 emitter 处理消息</span><br><span class="line">     *&#x2F;</span><br><span class="line">    receive(message, handle) &#123;</span><br><span class="line">        this.emitter.on(message, handle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="实现人类玩家"><a href="#实现人类玩家" class="headerlink" title="实现人类玩家"></a>实现人类玩家</h5><p>人类玩家通过 WebSocket 信道来实现玩家的输入输出，我们需要添加 game/Tunnel.js 和 game/HumanPlayer.js 来实现人类玩家逻辑，可参考下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">const EventEmitter &#x3D; require(&#39;events&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 封装 WebSocket 信道</span><br><span class="line"> *&#x2F;</span><br><span class="line">module.exports &#x3D; class Tunnel &#123;</span><br><span class="line">    constructor(ws) &#123;</span><br><span class="line">        this.emitter &#x3D; new EventEmitter();</span><br><span class="line">        this.ws &#x3D; ws;</span><br><span class="line">        ws.on(&#39;message&#39;, packet &#x3D;&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F; 约定每个数据包格式：&#123; message: &#39;type&#39;, data: any &#125;</span><br><span class="line">                const &#123; message, data &#125; &#x3D; JSON.parse(packet);</span><br><span class="line">                this.emitter.emit(message, data);</span><br><span class="line">            &#125; catch (err) &#123;</span><br><span class="line">                console.log(&#39;unknown packet: &#39; + packet);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    on(message, handle) &#123;</span><br><span class="line">        this.emitter.on(message, handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    emit(message, data) &#123;</span><br><span class="line">        this.ws.send(JSON.stringify(&#123; message, data &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">const co &#x3D; require(&#39;co&#39;);</span><br><span class="line">const Player &#x3D; require(&#39;.&#x2F;Player&#39;);</span><br><span class="line">const ComputerPlayer &#x3D; require(&#39;.&#x2F;ComputerPlayer&#39;);</span><br><span class="line">const Tunnel &#x3D; require(&#39;.&#x2F;Tunnel&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 人类玩家实现，通过 WebSocket 信道接收和发送消息</span><br><span class="line"> *&#x2F;</span><br><span class="line">module.exports &#x3D; class HumanPlayer extends Player &#123;</span><br><span class="line">    constructor(user, ws) &#123;</span><br><span class="line">        super(user);</span><br><span class="line">        this.ws &#x3D; ws;</span><br><span class="line">        this.tunnel &#x3D; new Tunnel(ws);</span><br><span class="line">        this.send(&#39;id&#39;, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 人类玩家上线后，还需要监听信道关闭，让玩家下线</span><br><span class="line">     *&#x2F;</span><br><span class="line">    online(room) &#123;</span><br><span class="line">        super.online(room);</span><br><span class="line">        this.ws.on(&#39;close&#39;, () &#x3D;&gt; this.offline());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 人类玩家请求电脑玩家</span><br><span class="line">        this.receive(&#39;requestComputer&#39;, () &#x3D;&gt; &#123;</span><br><span class="line">            const room &#x3D; this.room;</span><br><span class="line">            while(room &amp;&amp; !room.isFull()) &#123;</span><br><span class="line">                const computer &#x3D; new ComputerPlayer();</span><br><span class="line">                computer.online(room);</span><br><span class="line">                computer.simulate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 下线后关闭信道</span><br><span class="line">     *&#x2F;</span><br><span class="line">    offline() &#123;</span><br><span class="line">        super.offline();</span><br><span class="line">        if (this.ws &amp;&amp; this.ws.readyState &#x3D;&#x3D; this.ws.OPEN) &#123;</span><br><span class="line">            this.ws.close();</span><br><span class="line">        &#125;</span><br><span class="line">        this.ws &#x3D; null;</span><br><span class="line">        this.tunnel &#x3D; null;</span><br><span class="line">        if (this.room) &#123;</span><br><span class="line">            &#x2F;&#x2F; 清理房间里面的电脑玩家</span><br><span class="line">            for (let player of this.room.players) &#123;</span><br><span class="line">                if (player instanceof ComputerPlayer) &#123;</span><br><span class="line">                    this.room.removePlayer(player);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            this.room &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 通过 WebSocket 信道发送消息给玩家</span><br><span class="line">     *&#x2F;</span><br><span class="line">    send(message, data) &#123;</span><br><span class="line">        this.tunnel.emit(message, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 从 WebSocket 信道接收玩家的消息</span><br><span class="line">     *&#x2F;</span><br><span class="line">    receive(message, callback) &#123;</span><br><span class="line">        this.tunnel.on(message, callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="添加游戏服务入口"><a href="#添加游戏服务入口" class="headerlink" title="添加游戏服务入口"></a>添加游戏服务入口</h5><p>游戏的实现已经完成了，接下来，编辑 websocket.js 添加服务入口，可参考下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 引入 url 模块用于解析 URL</span><br><span class="line">const url &#x3D; require(&#39;url&#39;);</span><br><span class="line">&#x2F;&#x2F; 引入 ws 支持 WebSocket 的实现</span><br><span class="line">const ws &#x3D; require(&#39;ws&#39;);</span><br><span class="line">&#x2F;&#x2F; 引入人类玩家</span><br><span class="line">const HumanPlayer &#x3D; require(&#39;.&#x2F;game&#x2F;HumanPlayer&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 导出处理方法</span><br><span class="line">exports.listen &#x3D; listen;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 在 HTTP Server 上处理 WebSocket 请求</span><br><span class="line"> * @param &#123;http.Server&#125; server</span><br><span class="line"> * @param &#123;wafer.SessionMiddleware&#125; sessionMiddleware</span><br><span class="line"> *&#x2F;</span><br><span class="line">function listen(server, sessionMiddleware) &#123;</span><br><span class="line">    &#x2F;&#x2F; 使用 HTTP Server 创建 WebSocket 服务，使用 path 参数指定需要升级为 WebSocket 的路径</span><br><span class="line">    const wss &#x3D; new ws.Server(&#123; server &#125;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 同时支持 &#x2F;ws 和 &#x2F;game 的 WebSocket 连接请求 </span><br><span class="line">    wss.shouldHandle &#x3D; (request) &#x3D;&gt; &#123; </span><br><span class="line">        const path &#x3D; url.parse(request.url).pathname; </span><br><span class="line">        request.path &#x3D; path; </span><br><span class="line">        return [&#39;&#x2F;ws&#39;, &#39;&#x2F;game&#39;].indexOf(path) &gt; -1; </span><br><span class="line">    &#125;; </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 监听 WebSocket 连接建立</span><br><span class="line">    wss.on(&#39;connection&#39;, (ws, request) &#x3D;&gt; &#123;</span><br><span class="line">        &#x2F;&#x2F; request: 要升级到 WebSocket 协议的 HTTP 连接</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 被升级到 WebSocket 的请求不会被 express 处理，</span><br><span class="line">        &#x2F;&#x2F; 需要使用会话中间节获取会话</span><br><span class="line">        sessionMiddleware(request, null, () &#x3D;&gt; &#123;</span><br><span class="line">            const session &#x3D; request.session;</span><br><span class="line">            if (!session) &#123;</span><br><span class="line">                &#x2F;&#x2F; 没有获取到会话，强制断开 WebSocket 连接</span><br><span class="line">                ws.send(JSON.stringify(request.sessionError) || &quot;No session avaliable&quot;);</span><br><span class="line">                ws.close();</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&#96;WebSocket client connected with openId&#x3D;$&#123;session.userInfo.openId&#125;&#96;);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 根据请求的地址进行不同处理 </span><br><span class="line">            switch (request.path) &#123; </span><br><span class="line">                case &#39;&#x2F;ws&#39;: return serveMessage(ws, session.userInfo); </span><br><span class="line">                case &#39;&#x2F;game&#39;: return serveGame(ws, session.userInfo); </span><br><span class="line">                default: return ws.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 监听 WebSocket 服务的错误</span><br><span class="line">    wss.on(&#39;error&#39;, (err) &#x3D;&gt; &#123;</span><br><span class="line">        console.log(err);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 进行简单的 WebSocket 服务，对于客户端发来的所有消息都回复回去</span><br><span class="line"> *&#x2F;</span><br><span class="line">function serveMessage(ws, userInfo) &#123;</span><br><span class="line">    &#x2F;&#x2F; 监听客户端发来的消息</span><br><span class="line">    ws.on(&#39;message&#39;, (message) &#x3D;&gt; &#123;</span><br><span class="line">        console.log(&#96;WebSocket received: $&#123;message&#125;&#96;);</span><br><span class="line">        ws.send(&#96;Server: Received($&#123;message&#125;)&#96;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 监听关闭事件</span><br><span class="line">    ws.on(&#39;close&#39;, (code, message) &#x3D;&gt; &#123;</span><br><span class="line">        console.log(&#96;WebSocket client closed (code: $&#123;code&#125;, message: $&#123;message || &#39;none&#39;&#125;)&#96;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 连接后马上发送 hello 消息给会话对应的用户</span><br><span class="line">    ws.send(&#96;Server: 恭喜，$&#123;userInfo.nickName&#125;&#96;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 使用 WebSocket 进行游戏服务</span><br><span class="line"> *&#x2F;</span><br><span class="line">function serveGame(ws, userInfo) &#123;</span><br><span class="line">    const user &#x3D; &#123; </span><br><span class="line">        uid: userInfo.openId, </span><br><span class="line">        uname: userInfo.nickName, </span><br><span class="line">        uavatar: userInfo.avatarUrl </span><br><span class="line">    &#125;; </span><br><span class="line">    &#x2F;&#x2F; 创建玩家 </span><br><span class="line">    const player &#x3D; new HumanPlayer(user, ws); </span><br><span class="line">    &#x2F;&#x2F; 玩家上线</span><br><span class="line">    player.online();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="安装co模块"><a href="#安装co模块" class="headerlink" title="安装co模块"></a>安装co模块</h5><p>我们的源码中使用到了 co 进行协程管理，启动游戏服务前，需要先安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;release&#x2F;weapp</span><br><span class="line">npm install co --save</span><br></pre></td></tr></table></figure>
<h5 id="测试游戏模块"><a href="#测试游戏模块" class="headerlink" title="测试游戏模块"></a>测试游戏模块</h5><p>重启 Node 服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 restart app</span><br></pre></td></tr></table></figure>
<p>打开配套的小程序，点击 实验四 - 剪刀石头布小游戏，点击 开始 按钮进行游戏。</p>

      
      <!-- 打赏 -->
      
        <div id="reward-btn">
          打赏
        </div>
        
    </div>
    <footer class="article-footer">
      <a data-url="zhuxinzeng.club/2019/06/01/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%B9%8B%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%90%AD%E5%BB%BA/" data-id="ck4y8kz2h0013qgnr0lqd1r13"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">微信小程序</a></li></ul>

    </footer>

  </div>

  
  
  <nav class="article-nav">
    
      <a href="/2019/11/02/Vue%E8%B5%84%E6%BA%90/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            Vue资源
          
        </div>
      </a>
    
    
      <a href="/2019/05/24/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%B7%A8%E5%9F%9F%E8%8E%B7%E5%8F%96%E8%B5%84%E6%BA%90%E7%9A%84%E6%96%B9%E5%BC%8F/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">浏览器跨域获取资源的方式</div>
      </a>
    
  </nav>


  

  
  
<!-- valine评论 -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: '',
        app_key: '',
        path: window.location.pathname,
        avatar: 'mp',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2015-2020
        Brace
      </li>
      <li>
        
          Powered by
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <ul class="list-inline">
  <li>PV:<span id="busuanzi_value_page_pv"></span></li>
  <li>UV:<span id="busuanzi_value_site_uv"></span></li>
</ul>
        
      </li>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
    <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
    
    <aside class="sidebar">
      
        <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/avator.jpg" alt="Brace"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">目录</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E6%97%85%E8%A1%8C/">旅行</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/null">摄影</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2019/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
      </aside>
      <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
      
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




  
<script src="/js/tocbot.min.js"></script>

  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script>
  var ayerConfig = {
    mathjax: false
  }
</script>


<script src="/js/ayer.js"></script>


<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">



<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>
  
  
  </div>
</body>

</html>